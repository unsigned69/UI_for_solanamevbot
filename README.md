# SMB-UI — Solana MEV Bot Control Panel

Локальный веб-инструмент на Next.js 14 (App Router) для ручного управления Solana MEV-ботом. UI не выполняет фоновых задач и действует только по запросу пользователя.

## Возможности

- **Подбор токенов** по ручным фильтрам с учётом base/anchor токенов, которые читаются из TOML-конфига бота.
- **Управление конфигом**: редактирование только управляемого блока между маркерами с dry-валидацией, diff и автоматическими бэкапами.
- **Запуск/остановка бота** с формированием командной строки, ALT-флагами и dry-run режимом.
- **Поток логов** stdout/stderr бота через WebSocket.

## Стек

- Next.js 14 + React 18 + TypeScript
- Tailwind CSS для стилизации
- Zod для валидаций
- `@iarna/toml` для работы с TOML конфигом
- WebSocket (через встроенный API Next.js) для логов процесса

## Структура

```
smb-ui/
  app/
    token-picker/      # Фильтры и список кандидатов
    config/            # Управление TOML-конфигом (управляемый блок)
    run/               # Форма запуска и стрим логов
    api/               # REST & WS API для адаптеров, конфига и runner'а
  components/          # Клиентские компоненты UI
  lib/                 # Бизнес-логика, адаптеры, runner, схемы
  styles/, public/     # Tailwind и статика
```

## Окружение

Скопируйте `.env.example` в `.env.local` и задайте переменные:

```
BOT_CMD="node ./bot/index.js"             # команда запуска бота
BOT_WORKDIR="/absolute/path/to/bot"       # рабочая директория процесса
BOT_CONFIG_PATH="/absolute/path/to/config.toml"   # путь к TOML конфигу
RPC_ENDPOINT="https://..."                # основной RPC для бота (используется самим процессом)
PARSER_RPC_ENDPOINT="https://..."         # отдельный RPC для подбора кандидатов; при отсутствии используется RPC_ENDPOINT
EXTRA_FLAGS_DEFAULT=""                    # дополнительные флаги по умолчанию (опционально)
```

> **Важно:** base/anchor токены настраиваются вручную в TOML-файле и лишь читаются UI.
> Добавляйте/обновляйте их в секции `routing` вне управляемого блока UI, затем нажмите «Обновить» в интерфейсе.

## Скрипты

```bash
npm install         # установка зависимостей
npm run dev         # запуск Next.js в режиме разработки
npm run build       # сборка
npm run start       # запуск production-билда
npm run parser:fetch -- --filters '{"dexes":["pumpfun"],"poolTypes":["CPMM"]}'
                     # однократный парсинг кандидатов из CLI
npm run parser:write -- --filters '{...}' --managed '@/path/to/managed.json'
                     # парсинг + запись управляемого блока (см. раздел ниже)
```

Скрипты `parser:*` не требуют запущенного процесса бота — им достаточно валидного `BOT_CONFIG_PATH` и RPC.

## Парсер независим от запуска бота

- Экран `/token-picker` и CLI парсер не проверяют состояние процесса бота и работают автономно.
- Единственное требование к UI — наличие base/anchor токенов в TOML-конфиге. При их отсутствии кнопка «Обновить данные» заблокирована.
- Бот можно запускать и останавливать отдельно на странице `/run`; логи относятся только к процессу бота.

## CLI для парсера и записи конфига

В директории `scripts/` расположен `parser-cli.ts`, который повторяет логику `/api/fetch-candidates`.

```bash
# Получить кандидатов (stdin не требуется)
npm run parser:fetch -- --filters '{"dexes":["raydium"],"poolTypes":["CLMM"]}'

# Провести dry-валидацию текущего управляемого блока
npm run parser:fetch -- --filters '{"dexes":[],"poolTypes":["CPMM","CLMM","DLMM"]}' --dry-validate

# Записать новый управляемый блок (данные берутся из файла после префикса @)
npm run parser:write -- --filters '{"dexes":["meteora"],"poolTypes":["DLMM"]}' --managed '@/path/to/managed.json'

# Можно передать JSON нового блока через STDIN, если не используется --managed
cat ./managed.json | npm run parser:write -- --filters '{...}' --write-config
```

Флаги CLI:

- `--filters <json>` — JSON со всеми полями `FetchFilters` (как в API `/api/fetch-candidates`).
- `--dry-validate` — выполнить dry-валидацию управляемого блока (если не передан новый блок, берётся текущий из конфига).
- `--write-config` — записать новый управляемый блок (требуется передать JSON через STDIN или `--managed '@path'`).
- `--managed <json|@path>` — необязательный источник данных для нового блока (строка JSON или путь к файлу с префиксом `@`).

## Тест-план

1. **Отсутствие base/anchor** — UI показывает красный баннер и блокирует «Обновить данные».
2. **Подбор кандидатов** — по нажатию «Обновить данные» загружаются моки адаптеров, фильтры влияют на результат.
3. **Dry-валидация конфига** — API `/api/config/validate` возвращает оценку compute/ALT и предупреждения.
4. **Сохранение блока** — запись создаёт бэкап `config.toml.bak-YYYYMMDD-HHMMSS` и перезаписывает только управляемую секцию.
5. **Запуск Dry-run** — ALT чекбоксы заблокированы, команда содержит `--dry-run`, логи отображаются.
6. **Запуск с ALT-флагами** — отмеченные операции добавляются к команде запуска, отображаются в предпросмотре.
7. **WebSocket логи** — при работе процесса новые строки появляются в реальном времени; можно очистить окно.

## Ограничения

- UI не хранит и не отображает приватные ключи.
- Никаких фоновых обновлений: любые запросы к адаптерам выполняются только по кнопке.
- Управляемый блок TOML — единственная изменяемая область; остальная часть файла остаётся нетронутой.
- Перед записью управляемого блока выполняется dry-валидация compute/ALT, создаётся бэкап и показывается diff.
